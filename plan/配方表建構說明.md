# 配方表建構說明

## 實作完成內容

已完成配方管理系統的建構，包含以下功能：

### 1. 路由設定
- 已在 `src/router/index.js` 新增 Recipe 路由
- 路徑：`/main/Recipe`

### 2. 配方列表頁面 (`src/views/main/Recipe/index.vue`)
- 顯示配方列表（配方編號、產品名稱、版本、規格、成本等）
- 搜尋功能（支援配方編號、產品名稱）
- 統計資訊：
  - 配方總數
  - 平均原料數
  - 有版本號的配方數
  - 有備註的配方數
- 新增、編輯、刪除功能

### 3. 配方編輯元件 (`src/views/main/Recipe/Add.vue`)
- Dialog 形式的編輯介面
- **基本資訊區**：
  - 配方編號（必填，不可重複）
  - 產品名稱（必填）
  - 版本（手動輸入）
  - 產品規格
  - 組合數量（影響總生產量）
  - 生產批量（影響廠值計算）
  - 實驗批量（影響實驗值計算）
  - 備註
  
- **配方明細區**：
  - 從原料資料庫選擇原料
  - 表格顯示：序號、項次、料號、原料名稱、百分比、quprs、TTprs、廠值、實驗、廠商
  - 百分比可編輯，其他欄位自動計算
  - 支援新增、刪除原料
  - 底部顯示小計（總百分比、總成本）
  - 顯示總生產量、總成本、單位成本

## 資料結構

### 資料表：`recipe`

所有資料存儲在 `datalist` JSON 欄位中：

```json
{
  "recipeNumber": "FQ23015",
  "productName": "眼霜",
  "productSpec": "1000",
  "combinationQuantity": 1,
  "productionBatch": 1000,
  "experimentBatch": 200,
  "totalProduction": 1000,
  "unitCost": "304.20",
  "version": "v1.0",
  "notes": "備註文字",
  "items": [
    {
      "sequence": 1,
      "itemNumber": "A-1(50)",
      "materialNumber": "SC30001",
      "materialName": "1.3-BG",
      "percentage": "2.00",
      "quprs": 145,
      "ttprs": 2.9000,
      "factoryValue": 20,
      "experimentValue": 4.0000,
      "supplier": "亨元"
    }
  ],
  "createInfo": {
    "snkey": "1",
    "name": "系統管理員",
    "time": "2025-01-21 10:00:00"
  },
  "editInfo": []
}
```

## 計算公式

根據 Excel 配方工作表的公式實作：

### 主要欄位計算

1. **總生產量 (totalProduction)**
   - 公式：`combinationQuantity × productionBatch`
   - 範例：1 × 1000 = 1000

2. **單位成本 (unitCost)**
   - 公式：`總成本 / totalProduction`
   - 說明：總成本為所有 TTprs 的總和

### 配方明細計算

對於每一個原料項目：

1. **quprs（原料單價，單位：元/公斤）**
   - 公式：`rawMaterial.unitPrice × 1000`
   - 說明：從原料資料庫取得單價後乘以 1000
   - **重要**：加入配方時固定，不隨原料資料庫更新

2. **廠值 (factoryValue)**
   - 公式：`productionBatch × percentage / 100`
   - 範例：1000 × 2.00 / 100 = 20

3. **實驗 (experimentValue)**
   - 公式：`experimentBatch × percentage / 100`
   - 範例：200 × 2.00 / 100 = 4.0000

4. **TTprs（總價）**
   - 公式：`quprs × factoryValue / 1000`
   - 範例：145 × 20 / 1000 = 2.9000

### 小計計算

1. **總百分比**
   - 公式：`SUM(所有項目的 percentage)`
   - 建議：應為 100%（允許小數誤差）

2. **總成本**
   - 公式：`SUM(所有項目的 TTprs)`

## 使用流程

### 新增配方

1. 點擊「新增配方」按鈕
2. 輸入基本資訊（配方編號、產品名稱等）
3. 點擊「新增原料」按鈕
4. 在彈出視窗中搜尋並選擇原料
5. 輸入百分比（系統自動計算其他欄位）
6. 重複步驟 3-5 直到所有原料加入
7. 檢查總百分比是否為 100%
8. 點擊「確認新增」

### 編輯配方

1. 在配方列表點擊齒輪圖標選擇「修改」
2. 修改基本資訊或配方明細
3. 新增或刪除原料
4. 調整百分比（系統自動重新計算）
5. 點擊「確認修改」

### 刪除配方

1. 在配方列表點擊齒輪圖標選擇「刪除」
2. 確認刪除操作

## 注意事項

1. **配方編號**：必須唯一，不可重複
2. **百分比總和**：建議為 100%，系統會以顏色標示：
   - 綠色：100%（正常）
   - 黃色：< 100%（警告）
   - 紅色：> 100%（錯誤）
3. **原料單價**：加入配方時固定，不會隨原料資料庫的單價更新而改變
4. **自動計算**：當修改百分比、生產批量、實驗批量時，系統會自動重新計算所有相關數值
5. **版本管理**：版本號手動輸入，建議使用 v1.0、v1.1 等格式

## 資料庫建構

需要在 MariaDB 中建立 `recipe` 資料表：

```sql
CREATE TABLE IF NOT EXISTS `recipe` (
  `snkey` INT(11) NOT NULL AUTO_INCREMENT COMMENT '主鍵',
  `recipeNumber` VARCHAR(50) NOT NULL COMMENT '配方編號',
  `datalist` TEXT NOT NULL COMMENT 'JSON格式資料',
  `updateTime` DATETIME DEFAULT NULL COMMENT '更新時間',
  PRIMARY KEY (`snkey`),
  UNIQUE KEY `idx_recipeNumber` (`recipeNumber`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='配方資料表';
```

## 後續可擴充功能

1. 配方複製功能（快速建立相似配方）
2. 匯出 Excel 功能（匯出為配方格式）
3. 配方版本比較功能
4. 批次調整百分比功能
5. 配方成本分析報表
